name: PR Change Log

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  log-changes:
    name: Log PR Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff stats
        id: diff_stats
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # File change summary
          echo "## Changed Files Summary" > pr_changes.md
          echo "" >> pr_changes.md

          # Overall stats
          STATS=$(git diff --shortstat $BASE_SHA...$HEAD_SHA)
          echo "**Overall:** $STATS" >> pr_changes.md
          echo "" >> pr_changes.md

          # Files changed with status
          echo "### Files Changed" >> pr_changes.md
          echo "" >> pr_changes.md
          echo '| Status | File | Lines Added | Lines Removed |' >> pr_changes.md
          echo '|--------|------|-------------|---------------|' >> pr_changes.md

          git diff --numstat --diff-filter=ACDMRT $BASE_SHA...$HEAD_SHA | while read added removed file; do
            # Determine status
            STATUS=$(git diff --name-status $BASE_SHA...$HEAD_SHA -- "$file" | head -1 | cut -f1)
            case $STATUS in
              A) STATUS_LABEL="Added" ;;
              M) STATUS_LABEL="Modified" ;;
              D) STATUS_LABEL="Deleted" ;;
              R*) STATUS_LABEL="Renamed" ;;
              C*) STATUS_LABEL="Copied" ;;
              T) STATUS_LABEL="Type Changed" ;;
              *) STATUS_LABEL="Changed" ;;
            esac

            # Handle binary files
            if [ "$added" = "-" ]; then
              added="binary"
              removed="binary"
            fi

            echo "| $STATUS_LABEL | \`$file\` | +$added | -$removed |" >> pr_changes.md
          done

          echo "" >> pr_changes.md

          # Breakdown by directory
          echo "### Changes by Directory" >> pr_changes.md
          echo "" >> pr_changes.md
          git diff --stat $BASE_SHA...$HEAD_SHA | grep -E '^\s' | sed 's/|.*//' | xargs -I{} dirname {} | sort | uniq -c | sort -rn | while read count dir; do
            echo "- **$dir/**: $count file(s)" >> pr_changes.md
          done || true

          echo "" >> pr_changes.md

          # New dependencies check
          if git diff $BASE_SHA...$HEAD_SHA -- requirements.txt pyproject.toml setup.py setup.cfg | grep -q '^+'; then
            echo "### Dependency Changes" >> pr_changes.md
            echo "" >> pr_changes.md
            echo '```diff' >> pr_changes.md
            git diff $BASE_SHA...$HEAD_SHA -- requirements.txt pyproject.toml setup.py setup.cfg || true
            echo '```' >> pr_changes.md
            echo "" >> pr_changes.md
          fi

          # Large file warnings
          echo "### Warnings" >> pr_changes.md
          echo "" >> pr_changes.md
          LARGE_FILES=$(git diff --numstat $BASE_SHA...$HEAD_SHA | awk '$1 != "-" && ($1+$2) > 300 {print $3 " (" $1 "+" " / " $2 "-)" }')
          if [ -n "$LARGE_FILES" ]; then
            echo "Large changes detected in:" >> pr_changes.md
            echo "$LARGE_FILES" | while read line; do
              echo "- \`$line\`" >> pr_changes.md
            done
          else
            echo "No large file changes detected." >> pr_changes.md
          fi

          # Save as output
          BODY=$(cat pr_changes.md)
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('pr_changes.md', 'utf8');

            // Look for existing bot comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '<!-- pr-change-log-bot -->';
            const fullBody = `${marker}\n# PR Change Log\n\n${body}\n\n---\n*Updated: ${new Date().toISOString()}*`;

            const existingComment = comments.find(c => c.body.includes(marker));
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: fullBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: fullBody,
              });
            }
